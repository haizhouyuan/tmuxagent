<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>tmux panes</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 2rem;
        background: #f9fafb;
        color: #111827;
      }
      h1 {
        font-size: 1.8rem;
        margin-bottom: 1rem;
      }
      .grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
      .pane {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.1);
        border: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
      }
      .pane header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e5e7eb;
        background: #f3f4f6;
      }
      .pane header h2 {
        font-size: 1rem;
        margin: 0;
      }
      .meta {
        font-size: 0.8rem;
        color: #6b7280;
      }
      pre {
        flex: 1;
        margin: 0;
        padding: 1rem;
        background: #0f172a;
        color: #e2e8f0;
        overflow-y: auto;
        font-family: "IBM Plex Mono", SFMono-Regular, ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.85rem;
        max-height: 340px;
      }
      form {
        display: flex;
        gap: 0.5rem;
        padding: 0.75rem 1rem 1rem;
        border-top: 1px solid #e5e7eb;
      }
      input[type="text"] {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        font-family: inherit;
      }
      button {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 0.375rem;
        padding: 0.5rem 0.9rem;
        cursor: pointer;
      }
      button:hover {
        background: #1d4ed8;
      }
    </style>
  </head>
  <body>
    <h1>tmux panes</h1>
    <p>显示每个 tmux pane 的最新输出（最多 {{ capture_lines }} 行），并允许直接发送命令。</p>
    <div class="grid" id="pane-grid">
      {% for pane in panes %}
      {% set pane_dom_id = pane.pane_id.replace('%','pct') %}
      <div class="pane" data-pane-id="{{ pane.pane_id }}" id="pane-{{ pane_dom_id }}">
        <header>
          <h2>{{ pane.session }}/{{ pane.window }} <span class="meta">{{ pane.title }}</span></h2>
          <div class="meta">{{ pane.pane_id }}</div>
        </header>
        <pre id="output-{{ pane_dom_id }}">{{ '\n'.join(pane.lines[-capture_lines:]) }}</pre>
        <form onsubmit="return sendCommand(event, '{{ pane.pane_id }}', 'input-{{ pane_dom_id }}')">
          <input type="text" id="input-{{ pane_dom_id }}" placeholder="输入命令，回车提交" autocomplete="off" />
          <button type="submit">Send</button>
        </form>
      </div>
      {% endfor %}
    </div>
    <script>
      const refreshInterval = 2000;

      function encodePaneId(paneId) {
        return paneId.replace(/%/g, 'pct');
      }

      async function refreshPane(paneId) {
        try {
          const response = await fetch(`/api/panes/${encodeURIComponent(paneId)}/tail`);
          if (!response.ok) return;
          const data = await response.json();
          const domId = encodePaneId(paneId);
          const pre = document.getElementById(`output-${domId}`);
          if (pre) {
            pre.textContent = data.lines.join('\n');
            pre.scrollTop = pre.scrollHeight;
          }
        } catch (err) {
          console.error('Failed to refresh pane', paneId, err);
        }
      }

      function scheduleRefresh() {
        const panes = document.querySelectorAll('[data-pane-id]');
        panes.forEach((pane) => {
          const paneId = pane.getAttribute('data-pane-id');
          refreshPane(paneId);
        });
      }

      async function sendCommand(event, paneId, inputId) {
        event.preventDefault();
        const input = document.getElementById(inputId);
        const text = input.value.trim();
        if (!text) {
          return false;
        }
        try {
          const response = await fetch(`/api/panes/${encodeURIComponent(paneId)}/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: text })
          });
          if (!response.ok) {
            console.error('Failed to send command', await response.text());
          }
          input.value = '';
          refreshPane(paneId);
        } catch (err) {
          console.error('Failed to send command', err);
        }
        return false;
      }

      setInterval(scheduleRefresh, refreshInterval);
    </script>
  </body>
</html>
